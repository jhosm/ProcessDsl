<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="definitions_payment-process" targetNamespace="http://bpmn.io/schema/bpmn" exporter="BPM DSL" exporterVersion="1.0">
  <process id="payment-process" name="Payment Processing" isExecutable="true">
    <startEvent id="start-payment" name="Payment Request"/>
    <serviceTask id="validate-payment" name="Validate Payment">
      <extensionElements>
        <zeebe:taskDefinition type="payment-validator" retries="5"/>
        <zeebe:taskHeaders>
          <zeebe:header key="method" value="VISA"/>
          <zeebe:header key="timeout" value="30s"/>
        </zeebe:taskHeaders>
        <zeebe:ioMapping>
          <zeebe:input source="=amount" target="amount"/>
          <zeebe:input source="=cardNumber" target="cardNumber"/>
          <zeebe:input source="=cvv" target="cvv"/>
          <zeebe:output source="=isValid" target="isValid"/>
          <zeebe:output source="=validationErrors" target="validationErrors"/>
        </zeebe:ioMapping>
      </extensionElements>
    </serviceTask>
    <exclusiveGateway id="payment-valid-gateway" name="Payment Valid?" default="flow_payment-valid-gateway_to_end-failure"/>
    <serviceTask id="process-payment" name="Process Payment">
      <extensionElements>
        <zeebe:taskDefinition type="payment-processor" retries="3"/>
        <zeebe:taskHeaders>
          <zeebe:header key="provider" value="stripe"/>
          <zeebe:header key="currency" value="USD"/>
        </zeebe:taskHeaders>
        <zeebe:ioMapping>
          <zeebe:input source="=amount" target="amount"/>
          <zeebe:input source="=cardNumber" target="cardNumber"/>
          <zeebe:output source="=transactionId" target="transactionId"/>
          <zeebe:output source="=status" target="status"/>
        </zeebe:ioMapping>
      </extensionElements>
    </serviceTask>
    <serviceTask id="send-notification" name="Send Notification">
      <extensionElements>
        <zeebe:taskDefinition type="notification-service" retries="3"/>
        <zeebe:ioMapping>
          <zeebe:input source="=transactionId" target="transactionId"/>
          <zeebe:input source="=customerEmail" target="customerEmail"/>
        </zeebe:ioMapping>
      </extensionElements>
    </serviceTask>
    <endEvent id="end-success" name="Payment Completed"/>
    <endEvent id="end-failure" name="Payment Failed"/>
    <sequenceFlow id="flow_start-payment_to_validate-payment" sourceRef="start-payment" targetRef="validate-payment"/>
    <sequenceFlow id="flow_validate-payment_to_payment-valid-gateway" sourceRef="validate-payment" targetRef="payment-valid-gateway"/>
    <sequenceFlow id="flow_payment-valid-gateway_to_process-payment" sourceRef="payment-valid-gateway" targetRef="process-payment">
      <conditionExpression xsi:type="tFormalExpression">=isValid = true</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow_payment-valid-gateway_to_end-failure" sourceRef="payment-valid-gateway" targetRef="end-failure"/>
    <sequenceFlow id="flow_process-payment_to_send-notification" sourceRef="process-payment" targetRef="send-notification"/>
    <sequenceFlow id="flow_send-notification_to_end-success" sourceRef="send-notification" targetRef="end-success"/>
  </process>
  <bpmndi:BPMNDiagram id="diagram_payment-process">
    <bpmndi:BPMNPlane id="plane_payment-process" bpmnElement="payment-process">
      <bpmndi:BPMNShape id="shape_start-payment" bpmnElement="start-payment">
        <dc:Bounds x="50" y="150" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_validate-payment" bpmnElement="validate-payment">
        <dc:Bounds x="286" y="150" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_payment-valid-gateway" bpmnElement="payment-valid-gateway">
        <dc:Bounds x="586" y="150" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_process-payment" bpmnElement="process-payment">
        <dc:Bounds x="836" y="75" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_send-notification" bpmnElement="send-notification">
        <dc:Bounds x="1136" y="150" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_end-success" bpmnElement="end-success">
        <dc:Bounds x="1436" y="150" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_end-failure" bpmnElement="end-failure">
        <dc:Bounds x="836" y="217" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="edge_flow_start-payment_to_validate-payment" bpmnElement="flow_start-payment_to_validate-payment">
        <di:waypoint x="86" y="168"/>
        <di:waypoint x="186" y="168"/>
        <di:waypoint x="186" y="190"/>
        <di:waypoint x="286" y="190"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_flow_validate-payment_to_payment-valid-gateway" bpmnElement="flow_validate-payment_to_payment-valid-gateway">
        <di:waypoint x="386" y="190"/>
        <di:waypoint x="486" y="190"/>
        <di:waypoint x="486" y="175"/>
        <di:waypoint x="586" y="175"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_flow_payment-valid-gateway_to_process-payment" bpmnElement="flow_payment-valid-gateway_to_process-payment">
        <di:waypoint x="636" y="175"/>
        <di:waypoint x="736" y="175"/>
        <di:waypoint x="736" y="115"/>
        <di:waypoint x="836" y="115"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_flow_payment-valid-gateway_to_end-failure" bpmnElement="flow_payment-valid-gateway_to_end-failure">
        <di:waypoint x="636" y="175"/>
        <di:waypoint x="736" y="175"/>
        <di:waypoint x="736" y="235"/>
        <di:waypoint x="836" y="235"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_flow_process-payment_to_send-notification" bpmnElement="flow_process-payment_to_send-notification">
        <di:waypoint x="936" y="115"/>
        <di:waypoint x="1036" y="115"/>
        <di:waypoint x="1036" y="190"/>
        <di:waypoint x="1136" y="190"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_flow_send-notification_to_end-success" bpmnElement="flow_send-notification_to_end-success">
        <di:waypoint x="1236" y="190"/>
        <di:waypoint x="1336" y="190"/>
        <di:waypoint x="1336" y="168"/>
        <di:waypoint x="1436" y="168"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>