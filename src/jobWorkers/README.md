# ProcessDSL Job Workers

This package contains job workers for ProcessDSL BPM elements, designed to work with Camunda Zeebe.

## Overview

The ProcessDSL Job Workers provide runtime validation and processing capabilities for BPM processes generated by the ProcessDSL compiler.

## Workers

### Process Entity Validator

The `process-entity-validator` worker handles validation of data against OpenAPI schemas for `processEntity` elements.

**Features:**
- ✅ Accepts OpenAPI schemas as input variables (no file system access needed)
- ✅ Extracts entity definitions by entityName from components/schemas
- ✅ Validates processEntity variable against OpenAPI schema using AJV
- ✅ Handles schema references ($ref) between entities
- ✅ Provides detailed validation errors with field paths
- ✅ Supports all OpenAPI formats (string, email, date, patterns, etc.)
- ✅ Returns structured results to process via variables
- ✅ Graceful error handling for invalid schemas and missing data

**Task Type:** `process-entity-validator`

**Input Variables:**
- `processEntity` - The data to validate
- `openApiSchema` - The OpenAPI schema (as string or parsed object)

**Task Headers:**
- `entityModel` - Reference to the OpenAPI file path (for logging/tracking)
- `entityName` - Name of the entity in the OpenAPI schema

**Output Variables:**
- `validationResult` - Object containing:
  - `isValid` - Boolean indicating if validation passed
  - `errors` - Array of validation error messages (if any)
  - `entityName` - The entity name that was validated
  - `entityModel` - The OpenAPI file reference used

## Installation

```bash
npm install
```

## Usage

### Development Mode

```bash
npm run dev
```

### Production Mode

```bash
npm run build
npm start
```

### Watch Mode (for development)

```bash
npm run watch
```

## Building

```bash
npm run build
```

This will compile TypeScript files to the `dist/` directory.

## Configuration

The workers connect to Zeebe using the default configuration. You can customize the connection by setting environment variables:

- `ZEEBE_ADDRESS` - Zeebe gateway address (default: localhost:26500)
- `ZEEBE_CLIENT_ID` - Client ID for authentication
- `ZEEBE_CLIENT_SECRET` - Client secret for authentication

## Example OpenAPI Schema

```yaml
openapi: 3.0.0
info:
  title: Customer API
  version: 1.0.0
components:
  schemas:
    Customer:
      type: object
      required:
        - id
        - email
        - name
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        name:
          type: string
          minLength: 1
        age:
          type: integer
          minimum: 0
          maximum: 150
```

## Validation Results

### Success Response
```javascript
{
  validationResult: {
    isValid: true,
    errors: [],
    entityName: "Customer",
    entityModel: "api/specs/customer-api.yaml"
  }
}
```

### Failure Response
```javascript
{
  validationResult: {
    isValid: false,
    errors: [
      "/email: must match format \"email\"",
      "/age: must be >= 0"
    ],
    entityName: "Customer",
    entityModel: "api/specs/customer-api.yaml"
  }
}
```

## License

MIT
